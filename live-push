# 
# Replace xxVER and xxDATE
#
VERSION=1.17
DATE=2008-02-28
TMPDIR=/tmp/prestosidebarclock-$DATE-$VERSION-$$
TAG=live_push_$DATE

# 
# First check if any diffs need to be committed.  If so, cowardly
# refuse to push any changes
# 
MODIFIED=$(hg status | wc -l)
if [ $MODIFIED -ne 0 ]; then
  echo Uncommitted changes exist, cowardly refusing to proceed
  hg status $FILES
  exit 1
fi

# =====
echo Checking javascript files and minifying...
make -C common

# =====
echo Checking CSS files...
grep \.css MANIFEST | xargs -L1 csslint
  if [ $? -ne 0 ]; then
  echo Correct CSS errors and commit before proceeding
  exit 1
fi

# =====
echo Cloning repository to temp directory
hg clone . $TMPDIR
cd $TMPDIR

# =====
echo Removing .hg and .hgtags and other unnecessary files
rm -rf .hg .hgtags 
rm live-push

# =====
echo Setting version and date in files
find . -type f -name gadget.xml -o -name gadget.html -o -name settings.html -exec \
  sed -i -e "s/xxVER/$VERSION/g" -e "s/xxDATE/$DATE/g" "{}" -e "s/gadget.all.js/gadget.all.min.js/g" \;

# =====
echo Creating final zip/gadget file
FILES=$(cat MANIFEST)
ZIP=../prestosidebarclock-$VERSION.gadget
#7z a -tzip $ZIP *
7z a -tzip $ZIP $FILES

# =====
PWD=$(pwd)
echo Final gadget is at: $PWD/$ZIP
