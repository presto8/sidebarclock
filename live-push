# 
# Replace xxVER and xxDATE
#
VERSION=1.17
DATE=2008-02-28
TMPDIR=/tmp/prestosidebarclock-$DATE-$VERSION-$$
TAG=live_push_$DATE

# 
# First check if any diffs need to be committed.  If so, cowardly
# refuse to push any changes
# 
MODIFIED=$(hg status | wc -l)
if [ $MODIFIED -ne 0 ]; then
  echo Uncommitted changes exist, cowardly refusing to proceed
  hg status $FILES
  exit 1
fi

#
# Build jumbo javascript file
echo Checking javascript files...
make -C common

# =====
echo Cloning repository to temp directory
hg clone . $TMPDIR
cd $TMPDIR

# =====
echo Removing .hg and .hgtags and other unnecessary files
rm -rf .hg .hgtags 
rm live-push

# =====
echo Setting version and date in files
find . -type f -name gadget.xml -exec sed -i -e "s/xxVER/$VERSION/g" -e "s/xxDATE/$DATE/g" "{}" \;
find . -type f -name settings.html -exec sed -i -e "s/xxVER/$VERSION/g" -e "s/xxDATE/$DATE/g" "{}" \;

# =====
echo Minifying javascript
#for i in gadget.js formatDate.js noaa.js; do
	#/usr/local/bin/yuicompressor common/$i >common/$i.min
	#mv -f common/$i.min common/$i
#done

# =====
echo Creating final zip/gadget file
ZIP=../prestosidebarclock-$VERSION.gadget
7z a -tzip $ZIP *

# =====
PWD=$(pwd)
echo Final gadget is at: $PWD/$ZIP
