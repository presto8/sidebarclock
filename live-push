# 
# Replace xxVER and xxDATE
#
VERSION=1.17
DATE=2008-02-28
TMPDIR=/tmp/prestosidebarclock-$DATE-$VERSION-$$
TAG=live_push_$DATE

# 
# First check if any diffs need to be committed.  If so, cowardly
# refuse to push any changes
# 
MODIFIED=$(hg status | wc -l)
if [ $MODIFIED -ne 0 ]; then
  echo Uncommitted changes exist, cowardly refusing to proceed
  hg status $FILES
#  exit 1
fi

# =====
echo Checking javascript files and minifying...
make -C common

# =====
echo Checking CSS files...
grep \.css MANIFEST | xargs -L1 csslint
  if [ $? -ne 0 ]; then
  echo Correct CSS errors and commit before proceeding
  exit 1
fi

# =====
echo Cloning repository to temp directory
hg clone . $TMPDIR
cd $TMPDIR

# =====
echo Setting version and date in files
#for file in gadget.xml gadget.html settings.html common/gadget.all.min.js; do
#  icon -f latin1 -t utf-8 $file | perl -e "s/xxVER/$VERSION/g; s/xxDATE/$DATE/g; s/gadget.all.js/gadget.all.min.js/g;" | iconv -f utf-8 -t latin1 >$file.a
#  sed -i -e "s/xxVER/$VERSION/g" -e "s/xxDATE/$DATE/g" -e 's/gadget.all.js/gadget.all.min.js/g' $file
#done

# =====
echo Creating final zip/gadget file
FILES=$(cat MANIFEST)
ZIP=../prestosidebarclock-$VERSION.gadget
#7z a -tzip $ZIP *
7z a -tzip $ZIP $FILES

# =====
PWD=$(pwd)
echo Final gadget is at: $PWD/$ZIP
